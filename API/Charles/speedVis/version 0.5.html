<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Test</title>
    <style>
        * { padding: 0; margin: 0; }
        canvas { background: #eee; display: block; margin: 0 auto; }
    </style>
    
</head>
<body>
<div id="myDiv" style= "width: 450px; height: 0px;"> </div>


<canvas id="myCanvas" width="480" height="600"></canvas>
<img  id= "ANDGate" src = "Resources/Gates/and.png" style = "visibility: hidden; height:10; width:10;">
<img  id= "ORGate" src = "Resources/Gates/or.png" style = "visibility: hidden; height:10; width:10;">
<script src="http://www.d3plus.org/js/d3.js"></script>	
<script src="http://www.d3plus.org/js/d3plus.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script src="test.js"></script>
<script>
    
    //
    //Canvas Variables
    //
    var previousFrameTime = 0;
    var canvas = document.getElementById("myCanvas");
    var ctx = canvas.getContext("2d");
    
    //
    //Game Variables
    //
    var match = false;
    
    //
    //Button Variables
    //
    var upPressed = false;
    var downPressed = false;
    var rightPressed = false;
    var leftPressed = false;
    var spacePressed = false;

    //
    //Ball Variables
    //
    // var ballRadius=10;
    // var ballX = canvas.width/2;
    // var ballY = canvas.height-30;

    //
    //Gate Types
    //
    var gateType0=document.getElementById("ANDGate");
    var gateType1=document.getElementById("ORGate");
    //var gateType2=document.getElementById("");
    //var gateType3=document.getElementById("");
    //var gateType4=document.getElementById("");
    //var gateType5=document.getElementById("");

    //
    //Ball Object
    // -radius
    // -Coords - x and y
    //
    var ball = { radius:10, x: (canvas.width/2), y: (canvas.height-30)};

    //
    //Player Object
    // -lives 
    // -score
    // -value - 0 or 1
    //
    var player = { lives:['L','L','L','L','L','L','L','L','L','L'], score:0, value:1};
	var tempAPI = new test();
	tempAPI.structure("array")
		.location("#myDiv")
		.data(player.lives)
		.visualize();

    //
    //Gate Objects
    // -needed - 0 or 1
    // -Coords - x and y
    // -gate type - 0 or 1 for now
    //
    var gate1 = { need: 0, x:(canvas.width/4), y:-20, type:0};
    var gate2 = { need: 1, x:(2*(canvas.width/4)), y:-20, type:1};
    var gate3 = { need: 0, x:(3*(canvas.width/4)), y:-20, type:0};
 

    //
    //Event Listeners
    // -key pressed
    // -key released
    //
    document.addEventListener("keydown", keyDownHandler, false);
    document.addEventListener("keyup", keyUpHandler, false);


    /*Key Handlers

    keyDownhandler()
        -If one of the specified keys is pressed down, dectected by the key code, the value for that key is set to true.
    keyUpHandler()
        -If one of the specified keys is released, dectected by the key code, the value for that key is set to false.

    Keys Detected(key code):
    -Right Arrow(39) 
    -Left Arrow(37)
    -Up Arrow(38)
    -Down Arrow(40) 
    -Space Bar (32)              


    */
    function keyDownHandler(e) {
        if(e.keyCode == 39) {
            rightPressed = true;        
        }
        if(e.keyCode == 37) {
            leftPressed = true;
        }
        if(e.keyCode == 38){
            upPressed = true;

        }
        if(e.keyCode == 40){
            downPressed = true;
        }
        if(e.keyCode == 32){
            spacePressed = true;
        }
    }

    function keyUpHandler(e) {
        if(e.keyCode == 39) {
            rightPressed = false;
        }
        if(e.keyCode == 37) {
            leftPressed = false;
        }
        if(e.keyCode == 38){
            upPressed = false;

        }
        if(e.keyCode == 40){
            downPressed = false;
        }
        if(e.keyCode == 32){
            spacePressed = false;
        }
    }

    //
    //  drawBall()
    //  Creates ball at the bottom of the screen that the player uses to match their value to the gates falling.
    //
    function drawBall(){
        ctx.beginPath();
        ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI*2);
        ctx.fillStyle = "#000000";
        ctx.fill();
        ctx.closePath();

    }

    /*  drawGate()
        Creates a gate, given the x and y coordinates and an integer value represtening which gate type to create.
        Gate Types (Value representation):
            -AND (0)
            -OR (1)
            //-NAND (2??) to be added??
            //-XOR (3??)   to be added??
    */
    function drawGate(x, y, gate){
        if(gate== 0){
            ctx.beginPath();
            ctx.drawImage(gateType0,x, y, 60, 120);
            ctx.closePath();  
        }
        else if(gate ==1){
            ctx.beginPath();
            ctx.drawImage(gateType1,x, y, 60, 120);
            ctx.closePath();
        }
        
    }

    /*  changeGate()
        Function called to change the gates that are output. Each gate has a value that will satisfy the logic. The value is randomly slected between 0 or 1. For now the number that determines the gate, that is the value that satisfies that "gate". 
        
    */
    function changeGate(){
        //Randomly gives the player a new value of 0 or 1.
        player.value = Math.floor(Math.random()*2);
    
        //V Change value of the first gate V
        var temp = Math.floor(Math.random() * 2);
        while(temp == gate1.type){
            temp = Math.floor(Math.random() * 2);
        }


        gate1.type = temp;

        if(gate1.type == 0){
            gate1.need = 0;
        }
        else if(gate1.type == 1){
            gate1.need = 1;
        }
        
        //gate1.need = temp;

        //V change the value of the second gate V

        temp = Math.floor(Math.random() * 2);
        while(temp == gate2.type){
            temp = Math.floor(Math.random() * 2);
        }
        gate2.type = temp;

        if(gate2.type == 0){
            gate2.need = 0;
        }
        else if(gate2.type == 1){
            gate2.need = 1;
        }
        
        //gate2.need = temp;

        //V change the value of the third gate V

        temp = Math.floor(Math.random() * 2);
        while(temp == gate3.type){
            temp = Math.floor(Math.random() * 2);
        }
        gate3.type = temp;

        if(gate3.type == 0){
            gate3.need = 0;
        }
        else if(gate3.type == 1){
            gate3.need = 1;
        }
        
        gate3.need = temp;
    }
    /*  checkMatch()
        Function called to check whether the player's value matches the gate the player grabbed.

    */
    function checkMatch(gate){
        if(gate == "gate1"){
            if(gate1.need/*gate1Need*/ == player.value){
                player.score += 100;
            }else player.lives.pop();
        }
        else if(gate == "gate2"){
            if(gate2.need /*gate2Need*/ == player.value){
                player.score+= 100;
            }else player.lives.pop();
        }
        else if(gate =="gate3"){
            if(gate3.need /*gate3Need*/ == player.value){
                player.score+= 100;
            }else player.lives.pop();
        }
        else{
            player.lives.pop();       
        }

    }
    function resetGates(){
        changeGate();
        gate1.y = -20;
        gate2.y = -20;
        gate3.y = -20;
    }

    /*  checkCollision()
        This function is called everytime the screen is drawn. It checks whether the gates have either hit the bottom of the window or have hit the ball. This is done by checking the the x and y coordinates of the ball and the gates. If the gates hit the bottom of the window, they are reset and the player loses a life. If the gates come in contact with the ball, the player's vlaue and the gates needed value are checked. If they match, the score is increased by 100. If the values don't match, the player loses a life.

    */
    function checkCollision(){

        if(((gate1.y+60)||(gate2.y+60)||(gate3.y+60))== canvas.height){
            resetGates();
            player.lives.pop();
        } 
        if(ball.x >=gate1.x && ball.x <= (gate1.x+60) && (gate1.y+120) == (ball.radius + ball.y)){
            checkMatch("gate1");
            resetGates();
        }
        if(ball.x >=gate2.x && ball.x <= (gate2.x+60) && (gate2.y+120) == (ball.radius + ball.y)){
            checkMatch("gate2");
            resetGates();
        }
        if(ball.x >=gate3.x && ball.x <= (gate3.x+60) && (gate3.y+120) == (ball.radius + ball.y)){
            checkMatch("gate3");
            resetGates();
        }
    }

    //setUpScreen()
    //This function takes care of all the items that need to be put on the screen.
    //
    function setUpScreen(time){
        var FPS = Math.floor(1000 / (time - previousFrameTime));
        var fpsSTRING = FPS.toString();
        previousFrameTime = time;
        ctx.font = "12px Verdana";
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillText(fpsSTRING, 0, 10);
        ctx.fillText("FPS", 20, 10);
        ctx.fillText("Score:", 0, 30);
        ctx.fillText(player.score, 40, 30);
        ctx.fillText("Lives:", 0, 50);
        ctx.fillText(player.lives.length, 40, 50);
        ctx.fillText("Current Value:", 0, 600);
        ctx.fillText(player.value, 95, 600);
        ctx.fillText(gate1.need, canvas.width/4, 10);
        ctx.fillText(gate2.need, (2*(canvas.width/4)), 10);
        ctx.fillText(gate3.need, (3*(canvas.width/4)), 10);
    }

    //changePlayerValue()
    //This function is called when the mouse has been clicked. It will  change playerValue from a 1 to a 0 or a 0 to a 1.
    //
    function changePlayerValue(){
        if(player.value == 0){
                player.value = 1;
            }
            else{
                player.value = 0;
            }
    }
    /*  draw()
        This is the main function that draws the screen which includes the three gates, ball, score, lives, and FPS. The rate that the screen is drawn at varries.This is what frames per second(FPS) is in the top corner of the screen. 
    
        IF the left or right arrows are pressed  the x coordinate of the ball is chnaged; right arrow= +4, left arrow -4.
        The Y coordinate of the gates is increased, creating the animation of the gates falling.
        If the space bar is pressed the player's value  will change from 0 to 1 or vice versa. (kinda glitchy)

    */ 

    function draw(time) {
        requestAnimationFrame(draw);
        
        setUpScreen(time);

        checkCollision();
     
        drawGate(gate1.x, gate1.y, gate1.type);

        drawGate(gate2.x, gate2.y, gate2.type);

        drawGate(gate3.x, gate3.y, gate3.type);

        drawBall();
        ctx.fillStyle="#FF0000";
        ctx.fillText(player.value, ball.x-4, ball.y+2);

        //gateY = gateY + 1;
        gate1.y = gate1.y +1;
        gate2.y = gate2.y +1;
        gate3.y = gate3.y +1;

		tempAPI.update(player.lives);
		
        if (rightPressed && ball.x + ball.radius < canvas.width) {
            ball.x += 4;
        }
        if (leftPressed && ball.x - ball.radius > 0) {
            ball.x -= 4;
        }

        canvas.onclick = changePlayerValue;
    }

    requestAnimationFrame(draw);


</script>

</body>
</html>